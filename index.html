<!DOCTYPE html>
<html>
<style>
.mydivChild {
  margin-bottom: 10px; 
  cursor: move;
  background-color:grey;
  width: 300px;
  height: 30px;
  text-align: center;
}
.mydiv {
  width: 300px;
}
#parent {
  height: 1000px;
  position: relative;
}
</style>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
<body>

<h1>Draggable DIV Element</h1>

<p>Click and hold the mouse button down while moving the DIV element</p>

<div id="parent">
  	<div class="mydiv">
      <div class="mydivChild">1</div>
    </div>
  	<div class="mydiv">
      <div class="mydivChild">2</div>
    </div>
    <div class="mydiv">
      <div class="mydivChild">3</div>
    </div>
    <div class="mydiv">
      <div class="mydivChild">4</div>
    </div>
    <div class="mydiv">
      <div class="mydivChild">5</div>
    </div>
    <div class="mydiv">
      <div class="mydivChild">6</div>
    </div>
    <div class="mydiv">
      <div class="mydivChild">7</div>
    </div>
    <div class="mydiv">
      <div class="mydivChild">8</div>
    </div>
</div>

<script>

var virtualDiv = document.getElementById("virtualDiv");
var allDivs =  document.getElementsByClassName("mydiv");
var divNum = allDivs.length;
var index, groupIndex;
var previewBoxHeight = 30;
var groupDraggingDistance;
var lastChildFlag = false;
var groupDivNum = 1;
var groupFlag = false;
var groupMaxMargin = 0;

for( i = 0; i < divNum; i++ ){
    allDivs[i].classList.add(i);
}

// Get the parent element
var parent = document.getElementById('parent');

// Attach event listener to the parent
parent.addEventListener('mousedown', function(event) {
  // Get the clicked element
  var clickedElement = event.target;
  // Find the index of the clicked element 
  var children = Array.from(parent.children);
  children = children.filter(function(child) {
  return child.id !== "previewDiv";
  });
  
  index = children.indexOf(clickedElement.parentElement);
  var draggingDiv = document.getElementsByClassName(index)[0];

  if(draggingDiv !== undefined) {
    var dragLowerDiv;
    var selectLowerRect;
    var selectLowerElementOriginPosX;
    var selectRect = draggingDiv.getBoundingClientRect();
    var selectElementOriginPosX = selectRect.left - 8;

    if(index < 7) {
    dragLowerDiv = document.getElementsByClassName(index + 1)[0];
    selectLowerRect = dragLowerDiv.getBoundingClientRect();
	  selectLowerElementOriginPosX = selectLowerRect.left - 8; 
    }
    previewBoxHeight = 30;
    
    // chect if element has children
    if (selectLowerElementOriginPosX > selectElementOriginPosX) {
      groupFlag = true;
      groupMaxMargin = 40;
      groupIndex = index + 1;
      var childElement = dragLowerDiv.querySelector('.mydivChild');
      groupRect = dragLowerDiv.getBoundingClientRect();
      groupElementOriginPosX = groupRect.left - 8; 
      groupElementMarginLeft = 40;

      while (groupElementOriginPosX > selectElementOriginPosX){
        $(draggingDiv).append(childElement);
        groupDivNum++;
        childElement.style.marginLeft = groupElementMarginLeft + "px";
        groupIndex++;
        groupParentElement = document.getElementsByClassName(groupIndex)[0];
        if(groupParentElement == undefined) {
          lastChildFlag = true;
          break; }
        childElement = groupParentElement.querySelector('.mydivChild');

        groupRect = groupParentElement.getBoundingClientRect();
        groupElementOriginPosX = groupRect.left - 8;
        groupElementMarginLeft = groupElementOriginPosX;
        if(selectElementOriginPosX == 40) {
          groupElementMarginLeft = groupElementOriginPosX - 40;
        }
        
        if(groupElementOriginPosX > groupMaxMargin) {
          groupMaxMargin = groupElementOriginPosX;
        }
      } 
    }
    previewBoxHeight += 40 * (groupDivNum - 1);
    dragElement(draggingDiv);
  }
});

//Make the DIV element draggagle:
function dragElement(element) {

  var draggingX, draggingY, movingMousePosX, movingMousePosY;
  var dragEndPosX, dragEndPosY;
  var elementOriginPosX, elementOriginPosY, elementMovingPosY, elementMovingPosX, 
      upperElementPosX, upperElementPosY, lowerElementPosX, lowerElementPosY; 
  var mouseOriginPosX, mouseOriginPosY; 
  var stepX = 0, stepY = 40;
  var prependIndex, appendIndex, upperIndex, lowerIndex;
  var prependDiv, appendDiv, upperDiv, presentDiv;
  var previewDiv;
  var childElements;

  // start the drag funtionality
  dragMouseDown();

  function dragMouseDown(e) {

    e = e || window.event;
    e.preventDefault();
    element.style.position = "absolute"
    element.style.marginLeft = "0px";
    // get the original position of element:
    var rect = element.getBoundingClientRect();
	  elementOriginPosY = rect.top - 113.875; 
	  elementOriginPosX = rect.left - 8; 

    // get the mouse cursor position at startup:
   	mouseOriginPosX = e.clientX; 
    mouseOriginPosY = e.clientY; 
    movingMousePosX = e.clientX;
    movingMousePosY = e.clientY;

    // create preview box:
    previewDiv = document.createElement("div");
    previewDiv.style.borderStyle = "dotted";
    previewDiv.style.borderWidth = "1px";
    previewDiv.style.borderColor = "black";
    previewDiv.style.width = "200px";
    previewDiv.style.height = previewBoxHeight + "px";
    previewDiv.style.marginBottom = "10px";
    previewDiv.id = "previewDiv";

    if(index < 7) {
      prependIndex = index + 1;
      prependDiv =  document.getElementsByClassName(prependIndex)[0];
      $(prependDiv).before(previewDiv);
    } 
    if (lastChildFlag == true) {
      $("#previewDiv").remove();
    }
    
    document.onmouseup = closeDragElement;
    // call a function whenever the cursor moves:
    document.onmousemove = elementDrag;
  }

  function elementDrag(e) {
    e = e || window.event;
    e.preventDefault();
    // calculate the new cursor position:
    draggingX = movingMousePosX - e.clientX;
    draggingY = movingMousePosY - e.clientY;
    movingMousePosX = e.clientX;
    movingMousePosY = e.clientY;

    // set the element's new position during mousemoving:
    element.style.top = (element.offsetTop - draggingY) + "px";
    element.style.left = (element.offsetLeft - draggingX) + "px";
    elementMovingPosY = element.offsetTop - draggingY;
    elementMovingPosX = element.offsetLeft - draggingX;
    
    previewDiv.style.height = previewBoxHeight + "px";

   // set preview box position when dragging:
    if (e.clientY < mouseOriginPosY - 10 ) {
        $("#previewDiv").remove();

        // set preview box when vertical dragging
        prependIndex = parseInt((elementMovingPosY + 10) / 40);
        if(index == 0) {prependIndex = 1}
        if(prependIndex < 0) {prependIndex = 0}
        prependDiv =  document.getElementsByClassName(prependIndex)[0];
        $(prependDiv).before(previewDiv);

        // set preview box when horizontal dragging
        upperDiv = document.getElementsByClassName(prependIndex - 1)[0];
        if(upperDiv == undefined) {
          if(e.clientX > mouseOriginPosX + 10) {
            previewDiv.style.marginLeft = "40px";
          } else {
            previewDiv.style.marginLeft = "0px";
          }
        } else {
          if(parseInt(upperDiv.style.marginLeft) == 0 || isNaN(parseInt(upperDiv.style.marginLeft))) {
            if(elementMovingPosX < 20) {
              previewDiv.style.marginLeft = "0px";
            } else {
              previewDiv.style.marginLeft = "40px";
            }
          } else {
            if(parseInt(prependDiv.style.marginLeft) == 80) {
              if(elementMovingPosX < 60) {
                previewDiv.style.marginLeft = "40px"
              } else {
                previewDiv.style.marginLeft = "80px"
              }
            } else {
              if(elementMovingPosX < 20) {
                previewDiv.style.marginLeft = "0px"
              } else if(elementMovingPosX >= 20 && elementMovingPosX < 60) {
                previewDiv.style.marginLeft = "40px"
              } else {
                previewDiv.style.marginLeft = "80px"
              }
            }
          }
        }
    } else if (e.clientY > mouseOriginPosY + 10) {
        $("#previewDiv").remove();

        // set  preview box when vertical dragging
        prependIndex = parseInt((elementMovingPosY + 30) / 40);
        if(index < 7) {
            if(elementMovingPosY < 295) {
              prependDiv =  document.getElementsByClassName(prependIndex)[0];
              $(prependDiv).before(previewDiv);
              upperDiv = document.getElementsByClassName(prependIndex - 1)[0];
            } else {
              appendIndex = 7;
              appendDiv = document.getElementsByClassName(appendIndex)[0];
              $(appendDiv).after(previewDiv);
              upperDiv = appendDiv;
            }
        } else {
            appendIndex = 6;
            appendDiv =  document.getElementsByClassName(appendIndex)[0];
            $(appendDiv).after(previewDiv);
            upperDiv = appendDiv;
        }
        if(e.clientY <= mouseOriginPosY + previewBoxHeight) {
          upperDiv = document.getElementsByClassName(index - 1)[0];
        }

        // set  preview box when horizontal dragging
        if(upperDiv == undefined) {
          if(e.clientX > mouseOriginPosX + 10) {
            previewDiv.style.marginLeft = "40px";
          } else {
            previewDiv.style.marginLeft = "0px";
          }
        } else {
          if(parseInt(upperDiv.style.marginLeft) == 0 || isNaN(parseInt(upperDiv.style.marginLeft))) {
            if(elementMovingPosX < 20) {
              previewDiv.style.marginLeft = "0px";
            } else {
              previewDiv.style.marginLeft = "40px";
            }
          } else {
            if(parseInt(upperDiv.style.marginLeft) == 80) {
              previewDiv.style.marginLeft = "40px"
            } else {
              if(elementMovingPosX < 20) {
                previewDiv.style.marginLeft = "0px"
              } else if(elementMovingPosX >= 20 && elementMovingPosX < 60) {
                previewDiv.style.marginLeft = "40px"
              } else {
                previewDiv.style.marginLeft = "80px"
              }
            }
          }
        }
    } else if (e.clientY <= mouseOriginPosY + 10 && e.clientY >= mouseOriginPosY - 10) {
      $("#previewDiv").remove();

      // set  preview box when vertical dragging
      prependIndex = index + 1;
      appendIndex = index - 1;

      if(prependIndex < 7) {
        prependDiv =  document.getElementsByClassName(prependIndex)[0];
        $(prependDiv).before(previewDiv);
      } else {
        appendDiv =  document.getElementsByClassName(appendIndex)[0];
        $(appendDiv).after(previewDiv);
      }

      // set  preview box when horizontal dragging
      upperDiv = document.getElementsByClassName(index - 1)[0];
      if(upperDiv == undefined) {
        if(e.clientX > mouseOriginPosX + 10) {
          previewDiv.style.marginLeft = "40px";
        } else {
          previewDiv.style.marginLeft = "0px";
        }
      } else {
        if(elementOriginPosX == 0) {
          if(e.clientX > mouseOriginPosX + 10) {
            if(parseInt(upperDiv.style.marginLeft) == 0 || isNaN(parseInt(upperDiv.style.marginLeft))) {
              previewDiv.style.marginLeft = "40px"
            } else {
              if(elementMovingPosX < 20) {
                previewDiv.style.marginLeft = "0px"
              } else if(elementMovingPosX >= 20 && elementMovingPosX < 60) {
                previewDiv.style.marginLeft = "40px"
              } else {
                previewDiv.style.marginLeft = "80px"
              }
            }
          } else {
            previewDiv.style.marginLeft = "0px";
          }
        } else {
          if(elementMovingPosX > elementOriginPosX) {
            previewDiv.style.marginLeft = elementOriginPosX + "px"
          } else {
            if(parseInt(upperDiv.style.marginLeft) == 40) {
              if(elementMovingPosX < 20) {
                previewDiv.style.marginLeft = "0px"
              } else if(elementMovingPosX > 20 && elementMovingPosX < 60) {
                previewDiv.style.marginLeft = "40px"
              } else {
                previewDiv.style.marginLeft = "80px"
              }
            } else {
              if(elementMovingPosX < 20) {
                previewDiv.style.marginLeft = "0px"
              } else if(elementMovingPosX > 20 && elementMovingPosX < 60) {
                previewDiv.style.marginLeft = "40px"
              } else {
                previewDiv.style.marginLeft = "80px"
              }
            }
          }
        }
      }
    }
    if(groupMaxMargin == 80) {
      previewDiv.style.marginLeft = "0px";
    } else if(groupMaxMargin == 40) {
      if(elementMovingPosX < 20) {
        previewDiv.style.marginLeft = "0px"
      } else if(elementMovingPosX >= 20) {
        previewDiv.style.marginLeft = "40px"
      } 
    }
  }

  function closeDragElement(e) {
    e = e || window.event;
    e.preventDefault();

    $("#previewDiv").remove();
    element.style.position = "static";

    // set  element pos when close dragging
    if (e.clientY < mouseOriginPosY - 10 ) {

        prependIndex = parseInt((elementMovingPosY + 10) / 40);
        if(index == 0) {prependIndex = 1}
        if(prependIndex < 0) {prependIndex = 0}
        prependDiv =  document.getElementsByClassName(prependIndex)[0];
        $(prependDiv).before(element);

        upperDiv = document.getElementsByClassName(prependIndex - 1)[0];
        if(upperDiv == undefined) {
          if(e.clientX > mouseOriginPosX + 10) {
            element.style.marginLeft = "40px";
          } else {
            element.style.marginLeft = "0px";
          }
        } else {
          if(parseInt(upperDiv.style.marginLeft) == 0 || isNaN(parseInt(upperDiv.style.marginLeft))) {
            if(elementMovingPosX < 20) {
              element.style.marginLeft = "0px";
            } else {
              element.style.marginLeft = "40px";
            }
          } else {
            if(parseInt(prependDiv.style.marginLeft) == 80) {
              if(elementMovingPosX < 60) {
                element.style.marginLeft = "40px"
              } else {
                element.style.marginLeft = "80px"
              }
            } else {
              if(elementMovingPosX < 20) {
                element.style.marginLeft = "0px"
              } else if(elementMovingPosX >= 20 && elementMovingPosX < 60) {
                element.style.marginLeft = "40px"
              } else {
                element.style.marginLeft = "80px"
              }
            }
          }
        }
    } else if (e.clientY > mouseOriginPosY + 10) {

        prependIndex = parseInt((elementMovingPosY + 30) / 40);
        if(index < 7) {
          if(elementMovingPosY < 295) {
              prependDiv =  document.getElementsByClassName(prependIndex)[0];
              $(prependDiv).before(element);
              upperDiv = document.getElementsByClassName(prependIndex -1)[0];
          } else {
              appendIndex = 7;
              appendDiv = document.getElementsByClassName(appendIndex)[0];
              $(appendDiv).after(element);
              upperDiv = appendDiv;
          }
        } else {
          appendIndex = 6;
          appendDiv =  document.getElementsByClassName(appendIndex)[0];
          $(appendDiv).after(element);
          upperDiv = appendDiv;
        }
        if(e.clientY <= mouseOriginPosY + previewBoxHeight) {
          upperDiv = document.getElementsByClassName(index - 1)[0];
        }

        if(upperDiv == undefined) {
          if(e.clientX > mouseOriginPosX + 10) {
            element.style.marginLeft = "40px";
          } else {
            element.style.marginLeft = "0px";
          }
        } else {
          if(parseInt(upperDiv.style.marginLeft) == 0 || isNaN(parseInt(upperDiv.style.marginLeft))) {
            if(elementMovingPosX < 20) {
              element.style.marginLeft = "0px";
            } else {
              element.style.marginLeft = "40px";
            }
          } else {
            if(parseInt(upperDiv.style.marginLeft) == 80) {
              element.style.marginLeft = "40px"
            } else {
              if(elementMovingPosX < 20) {
                element.style.marginLeft = "0px"
              } else if(elementMovingPosX >= 20 && elementMovingPosX < 60) {
                element.style.marginLeft = "40px"
              } else {
                element.style.marginLeft = "80px"
              }
            }
          }
        }
    } else if (e.clientY <= mouseOriginPosY + 10 && e.clientY >= mouseOriginPosY - 10) {
      prependIndex = index + 1;
      appendIndex = index - 1;

      if(prependIndex < 7) {
        prependDiv =  document.getElementsByClassName(prependIndex)[0];
        $(prependDiv).before(element);
      } else {
        appendDiv =  document.getElementsByClassName(appendIndex)[0];
        $(appendDiv).after(element);
      }

      // set  preview box when horizontal dragging
      upperDiv = document.getElementsByClassName(index - 1)[0];
      if(upperDiv == undefined) {
        if(e.clientX > mouseOriginPosX + 10) {
          element.style.marginLeft = "40px";
        } else {
          element.style.marginLeft = "0px";
        }
      } else {
        if(elementOriginPosX == 0) {
          if(e.clientX > mouseOriginPosX + 10) {
            if(parseInt(upperDiv.style.marginLeft) == 0 || isNaN(parseInt(upperDiv.style.marginLeft))) {
              element.style.marginLeft = "40px"
            } else {
              if(elementMovingPosX < 20) {
                element.style.marginLeft = "0px"
              } else if(elementMovingPosX >= 20 && elementMovingPosX < 60) {
                element.style.marginLeft = "40px"
              } else {
                element.style.marginLeft = "80px"
              }
            }
          } else {
            element.style.marginLeft = "0px";
          }
        } else {
          if(elementMovingPosX > mouseOriginPosX + 10) {
            element.style.marginLeft = elementOriginPosX + "px"
          } else {
            if(parseInt(upperDiv.style.marginLeft) == 40) {
              if(elementMovingPosX < 20) {
                element.style.marginLeft = "0px"
              } else if(elementMovingPosX > 20 && elementMovingPosX < 60) {
                element.style.marginLeft = "40px"
              } else {
                element.style.marginLeft = "80px"
              }
            } else {
              if(elementMovingPosX < 20) {
                element.style.marginLeft = "0px"
              } else if(elementMovingPosX > 20 && elementMovingPosX < 60) {
                element.style.marginLeft = "40px"
              } else {
                element.style.marginLeft = "80px"
              }
            }
          }
        }
      }
    }
    if(groupMaxMargin == 80) {
      element.style.marginLeft = "0px";
    } else if(groupMaxMargin == 40) {
      if(elementMovingPosX < 20) {
        element.style.marginLeft = "0px"
      } else if(elementMovingPosX >= 20) {
        element.style.marginLeft = "40px";
      } else if(elementMovingPosX == undefined) {
        element.style.marginLeft = "40px";
      }
    }

// initializing everything
  // initializing position
    var rect = element.getBoundingClientRect();
	  elementEndPosY = rect.top - 113.875; 
	  elementEndPosX = rect.left - 8; 
    element.style.top = elementEndPosY + "px";
    element.style.left = elementEndPosX + "px";

  // seperation individual div
    childElements = element.querySelectorAll('.mydivChild');
    // Check if the seperating child elements exists and if yes, seperating the elements
    if (childElements.length >= 2) {
    // Get the second child elements
    var secondChildElement = childElements[1];
    groupIndex = index + 1;
    var secondEmptyDiv = document.getElementsByClassName( groupIndex )[0];
    element.after(secondEmptyDiv);
    secondEmptyDiv.style.marginLeft = (parseInt(secondChildElement.style.marginLeft) + parseInt(element.style.marginLeft)) + "px";
    secondChildElement.style.marginLeft = "0px";
    secondEmptyDiv.prepend(secondChildElement);
    for ( k=2; k < childElements.length; k++) {
      var seperatingChildElement = childElements[k];
      groupIndex++;
      var nextEmptyDiv = document.getElementsByClassName( groupIndex )[0];
      secondEmptyDiv.after(nextEmptyDiv);
      nextEmptyDiv.style.marginLeft = (parseInt(seperatingChildElement.style.marginLeft) + parseInt(element.style.marginLeft)) + "px";
      seperatingChildElement.style.marginLeft = "0px";
      nextEmptyDiv.prepend(seperatingChildElement);
      secondEmptyDiv = nextEmptyDiv;
     }
    }
    
    for( i = 0; i < divNum; i++ ){
      allDivs[i].className = "mydiv";
      allDivs[i].classList.add(i);
      allDivs[i].style.top = (i * 40) + "px";
    }

    groupDivNum = 1;
    groupMaxMargin = 0;
    groupFlag = false;
    $("#previewDiv").remove();

    document.onmouseup = null;
    document.onmousemove = null;
  }
}
</script>

</body>
</html>
